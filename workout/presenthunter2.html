<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>An Elf Christmas Tale</title>
  <style>
    * { padding: 0; margin: 0; }
    canvas { background: #eee; display: block; margin: 0 auto; }
  </style>
</head>
<body>
  <canvas id="myCanvas" width="800" height="600"></canvas>
	<script>
		var canvas = document.getElementById("myCanvas");
		var context = canvas.getContext("2d");

		/* --------------------------------------------------------------------- */
		var width = 800;
		var height = 600;
		var floorHeight = 10;
		var rightPressed = false;
    var leftPressed = false;
    var upPressed = false;
		var downPressed = false;

		/* ---------------------------------------------------------------------- */
		document.addEventListener("keydown", keyDownHandler, false);
		document.addEventListener("keyup", keyUpHandler, false);
    /* ---------------------------------------------------------------------- */

    class Map {
      constructor(string, sz, padX, padY, fg = "#696969", bg = "#EEEEEE") {
        this.nrow = string.lenght;
        this.ncol = string[ 0 ].split("");
        this.padX = padX;
        this.padY = padY;
        this.sz = sz;
        this.grid = [];
        this.text = [];
        this.elf = null;
        this.fg = fg;
        this.bg = bg;
        this.victory = false;
        this.process(string);
      }

      process(string) {
        let accumY = this.padY;
        for(let ii = 0; ii < string.length; ii++) {
          let row = [];
          let accumX = this.padX;
          let sline = string[ ii ].split("");
          for(let jj = 0; jj < sline.length; jj++) {
            let tile = new Tile(accumX, accumY, this.sz, sline[ jj ],
              this.fg, this.bg)
            row.push(tile);
            switch (tile.type) {
              case "1": // Elf
                this.elf = new Elf(accumX, accumY, ii, jj, this.sz);
                break;
              default:

            }
            accumX += this.sz;
          }
          this.grid.push(row);
          accumY += this.sz;
        }
      }

      collide() {
        if(this.grid[this.elf.i][this.elf.j].type == "2") {
          this.victory = true;
        }
      }

      has_win() {
        return(this.victory);
      }

			draw(ctx) {
        ctx.clearRect(0, 0, width, height);
        this.grid.forEach(row => row.forEach(elm => elm.draw(ctx)));
        this.text.forEach(txt => txt.draw(ctx));
        this.elf.move(this.grid);
        this.collide();
        this.elf.draw(ctx);

        return(map.has_win());
			}

      add_text(text) {
        this.text.push(text);
      }
    }

    class Tile {
      constructor(posX, posY, sz, type, fg, bg) {
        this.x = posX;
        this.y = posY;
        this.type = type;
        this.sz = sz;
        this.fg = fg;
        this.bg = bg;
      }
      draw(ctx) {
        ctx.beginPath();
        switch (this.type) {
          case " ":
            ctx.fillStyle = this.bg;
            ctx.fillRect(this.x, this.y, this.sz, this.sz);
            break;
          case "1":
            ctx.fillStyle = this.bg;
            ctx.fillRect(this.x, this.y, this.sz, this.sz);
            //ctx.fillStyle = "#FF0000";
            //ctx.arc(this.x + this.sz / 2, this.y + this.sz / 2, this.sz / 4, 0, 2 * Math.PI);
            //ctx.fill();
            break;
          case "2":
            ctx.fillStyle = this.bg;
            ctx.fillRect(this.x, this.y, this.sz, this.sz);
            ctx.fillStyle = "#00FF00";
            ctx.arc(this.x + this.sz / 2, this.y + this.sz / 2, this.sz / 4, 0, 2 * Math.PI);
            ctx.fill();
            break;
          default:
            ctx.fillStyle = this.fg;
            ctx.fillRect(this.x, this.y, this.sz, this.sz);
            break;
        }
        ctx.closePath();
      }
    }

    class Elf {
      constructor(x, y, i, j, sz, direction = "stop") {
        this.x = x;
        this.y = y;
        this.i = i;
        this.j = j;
        this.sz = sz;
        this.h = 20;
        this.w = 10;
        this.direction = direction;
        this.options = [ true, true, true, true ];
        this.bodyColor = "#32CD32";
        this.fleshColor = "#FFE4B5";
      }

      set_direction(direction) {
        this.direction = direction;
      }

      update_options(grid) {
        this.options[0] = grid[this.i - 1][this.j].type != "X" // 12h
        this.options[1] = grid[this.i][this.j + 1].type != "X" // 03h
        this.options[2] = grid[this.i + 1][this.j].type != "X" // 06h
        this.options[3] = grid[this.i][this.j - 1].type != "X" // 09h
        //console.log("Updated options: (", this.i, this.j, ") [", this.options[0], this.options[1], this.options[2], this.options[3], "]")
      }

      draw(ctx) {
        var xB = this.x + 25 / 2;
        var xH = this.x + 25 / 1.7;
        var yB = this.y + this.sz - this.w / 2;
        var yF = this.y + this.sz - this.w * 1.3;
        var yH = this.y + this.sz - this.w * 1.7;

        ctx.beginPath();
        ctx.arc( xB, yB, this.w / 2, 0, 2 * Math.PI, false );
        ctx.fillStyle = this.bodyColor;
        ctx.fill();
        ctx.closePath();

        ctx.beginPath();
        ctx.arc( xB, yF, this.w / 4, 0, 2 * Math.PI, false );
        ctx.fillStyle = this.fleshColor;
        ctx.fill();
        ctx.closePath();

        ctx.beginPath();
        ctx.arc( xH, yH, this.w / 6, 0, 2 * Math.PI, false );
        ctx.fillStyle = this.bodyColor;
        ctx.fill();
        ctx.closePath();
      }

      move(grid) {
        this.update_options(grid);

        if(this.direction != "stop") {
          switch( this.direction ) {
            case "right":
              if(this.options[1]) {
                //this.x += this.speed;
                this.j += 1
                this.x += this.sz;
              }
              break;
            case "left":
              if(this.options[3]) {
                //this.x -= this.speed;
                this.j -= 1
                this.x -= this.sz;
              }
              break;
            case "up":
              if(this.options[0]) {
                //this.y -= this.speed;
                this.i -= 1
                this.y -= this.sz;
              }
              break;
            case "down":
              if(this.options[2]) {
                //this.y += this.speed;
                this.i += 1
                this.y += this.sz;
              }
              break;
          }
        }
      }
    }

    class Text {
      constructor(x, y, size, text, color="#FFA500") {
        this.x = x; this.y = y; this.size = size; this.text = text;
        this.color = color;
      }

      draw(ctx) {
        if(this.size == "small") {
          ctx.font = "11px sans-serif";
        }
        if(this.size == "normal") {
          ctx.font = "16px sans-serif";
        }
        if(this.size == "large") {
          ctx.font = "48px sans-serif";
        }
        ctx.fillStyle = this.color;
        ctx.fillText(this.text, this.x, this.y);
      }
    }

    /* ---------------------------------------------------------------------- */
    console.log( "Creating map" );
    function Level1() {
      var map = new Map(["XXXXX", "X1XXX", "X   X", "XXX2X", "XXXXX"],
        25, 10, 10);
      return(map);
    }
    function Level2() {
      var map = new Map(["XXXXXXXXXXXXXXXXX", "X1XX       X   2X",
        "X XX XXXXX X XXXX", "X XX  XXXX X  XXX", "X XXX XXXX XX XXX",
        "X     XXX  XX   X", "XXXXXXXXX XXXXX X", "XXXXXXX         X",
        "XXXXXXXXXXXXXXXXX"], 25, 10, 10);
      return(map);
    }
    /* ---------------------------------------------------------------------- */
    function create_starring() {
      let foregroud = "#EEEEEE";
      let background = "#EEEEEE";
      var map = new Map(["XXX", "X1X", "XXX"], 25, 350, 100,
        foregroud, background);
      map.add_text(new Text(360, 175, "small", "Welcome to", color="#8B0000"));
      map.add_text(new Text(310, 200, "normal", "An Elf Christmas Tale", color="#006400"));
      map.add_text(new Text(320, 225, "small", "Press 'up' to sart the game", color="#8B0000"));
      return(map);
    }
    function create_ending() {
      let foregroud = "#EEEEEE";
      let background = "#EEEEEE";
      var map = new Map(["XXX", "X1X", "XXX"], 25, 350, 100,
        foregroud, background);
      return(map);
    }
    /* ---------------------------------------------------------------------- */
    var gameStatus = "staring";
    var gameLevel = 1;
    var starring = create_starring();
    var ending = create_ending();
    var map = Level1();
    /* ---------------------------------------------------------------------- */
    function game() {
      var victory = false;
      switch(gameStatus) {
        case "staring":
          starring.draw(context);
          if(upPressed) {
            gameStatus = "play";
          }
          break;
        case "play":
          victory = draw();
          if(victory) {
            gameLevel += 1;
            switch(gameLevel) {
              case 2:
                map = Level2();
                break;
              default:
                gameStatus = "end";
                break;
            }
          }
          break;
        case "end":
          ending.draw(context);
          break;
        default:
      }
    }

    function draw() {
      if(rightPressed) {
        map.elf.set_direction("right");
        rightPressed = false;
      }
      if(leftPressed) {
        map.elf.set_direction("left");
        leftPressed = false;
      }
      if(upPressed) {
        map.elf.set_direction("up");
        upPressed = false;
      }
      if(downPressed) {
        map.elf.set_direction("down");
        downPressed = false;
      }
      return(map.draw(context));
    }
    /* ---------------------------------------------------------------------- */
		function keyDownHandler(e) {
			if(e.keyCode == 39) {
				console.log("right arrow key was pressed.");
				rightPressed = true;
			} else if(e.keyCode == 37) {
				console.log("left arrow key was pressed.");
				leftPressed = true;
			} else if(e.keyCode == 38) {
				console.log("up arrow was pressed.");
				upPressed = true;
			} else if(e.keyCode == 40) {
				console.log("down arrow was pressed.");
				downPressed = true;
			} else if(e.keyCode == 32) {
				console.log("space key was pressed.");
			}
		}

    function keyUpHandler(e) {
      if(e.keyCode == 39) {
        rightPressed = false;
      } else if(e.keyCode == 37) {
        leftPressed = false;
      } else if(e.keyCode == 38) {
        upPressed = false;
      } else if(e.keyCode == 40) {
        downPressed = false;
      } else if(e.keyCode == 32) {
      }
    }

		setInterval(game, 30);
	</script>
</body>
</html>
