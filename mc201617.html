<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>A Snowman Christmas Story</title>
    <style>
		* { padding: 0; margin: 0; }
		canvas { background: #eee; display: block; margin: 0 auto; }
    </style>
</head>
<body>
	<canvas id="myCanvas" width="480" height="320"></canvas>
	<script>
		var canvas = document.getElementById("myCanvas");
		var ctx = canvas.getContext("2d");
		
		/* -------------------------------------------------------------- */
		var width = 480;
		var height = 320;
		var floorHeight = 10;
		var rightPressed = false;
		var leftPressed = false;
		var upPressed = false;

		/* -------------------------------------------------------------- */
		document.addEventListener("keydown", keyDownHandler, false);
		document.addEventListener("keyup", keyUpHandler, false);

		/* -------------------------------------------------------------- */
		class Floor {
			constructor(x, y, w, name="floor", color="#C0C0C0") {
				this.x = x; this.y = y; this.w = w; this.h = floorHeight;
				this.name = name; this.color = color;
				console.log(this.name + ' at (x:' + this.x + ', y:' + this.y + ') width (w: ' + this.w + ', h:' + this.h + ').');
			}

			draw() {
				ctx.beginPath();
				ctx.rect(this.x, this.y - this.h, this.w, this.h);
				ctx.fillStyle = this.color;
				ctx.fill();
				ctx.closePath();
			}

			collide(sm) { }
		}

		class Exit {
			constructor(x, y, visible=false, name="exit", color="#6B8E23") {
				this.x = x; this.y = y; this.h = 30; this.w = 20;
				this.name = name; this.color = color; this.visible = visible;
				console.log(this.name + ' at (x:' + this.x + ', y:' + this.y + ').');
			}

			draw() {
				if(this.visible) {
					var yS = this.y - 25;
					ctx.beginPath();
					ctx.arc(this.x + this.w / 2, yS, (this.w / 2), Math.PI, 0);
					ctx.rect(this.x, yS, this.w, 25);
					ctx.fillStyle = this.color;
					ctx.fill();
					ctx.closePath();
				}
			}

			collide(sm) {
				if(this.y == sm.y) {
					if(sm.x > this.x && sm.x + sm.w < this.x + this.w && sm.hat) {
						console.log(sm.name + " is in the same h level than " + this.name + " and has the hat.");
						sm.movement = "stop";
					}
				}
			}
		}

		class Hat {
			constructor(x, y, visible=true, name="hat", color="#FF6347") {
				this.x = x; this.y = y; this.h = 6; this.w = 16;
				this.name = name; this.color = color; this.visible = visible;
				console.log(this.name + ' at (x:' + this.x + ', y:' + this.y + ').');
			}

			draw() {
				if(this.visible) {
					var yb = this.y - 2;
					ctx.beginPath();
					ctx.arc(this.x + 8, yb, 4, Math.PI, 0);
					ctx.rect(this.x, yb, 16, 2);
					ctx.fillStyle = this.color;
					ctx.fill();
					ctx.closePath();
				}
			}

			collide(sm, ex) {
				if(sm.y == this.y) { // y-axis
					// console.log(sm.name + " is in the same h level than " + this.name + ".")
					if(sm.x + (sm.w / 2) >= this.x) {
						console.log(sm.name + "got the " + this.name + ".")
						this.visible=false;
						sm.hasHat();
						ex.visible=true;
					}
				}
			}
		}

		class Snowman {
			constructor(x, y, speed=2, strenght=2, name="snowman", color="#0095DD", hatColor="#FF6347") {
				this.x = x; this.y = y; this.h = 20; this.w = 14;
				this.name = name; this.color = color; this.hat=false;
				this.movement = "stop"; this.speed = speed; this.strenght = strenght;
				this.hatColor = hatColor;
				this.direction = "fall"; this.cnt = 0;
				console.log(this.name + ' at (x:' + this.x + ', y:' + this.y + ').');
			}

			draw() {
				var x = this.x + this.w / 2;
				var yB = this.y - 7;
				var yS = this.y - 14;
				ctx.beginPath();
				ctx.arc(x, yS, 4, 0, Math.PI*2);
				ctx.arc(x, yB, 7, 0, Math.PI*2);
				ctx.fillStyle = this.color;
				ctx.fill();
				ctx.closePath();
				
				if(this.hat) {
					var yH = this.y - 18;
					ctx.beginPath();
					ctx.arc(x, yH, 4, Math.PI, 0);
					ctx.rect(x - 8, yH, 16, 2);
					ctx.fillStyle = this.hatColor;
					ctx.fill();
					ctx.closePath();
				}
			}

			toggleMovement(mov) {
				console.log(this.name + " toggled direction.")
				// this.movement = ((this.movement == "right") ? "left" : "right");
				if(this.movement != "stop") {
					this.movement = mov;
				}
			}

			start(direction) {
				if(this.movement == "stop") {
					console.log(this.name + " started to move.")
					this.movement = direction;
				}
			}

			move() {
				if(this.movement != "stop") {
					this.x += ((this.movement == "right") ? this.speed : -this.speed);
				}
			}

			jump() {
				this.direction = "jump"
			}

			fall(floorObjects) {
				if(this.direction == "jump" && this.cnt < 10) {
					this.cnt += 1;
					this.y -= this.strenght;
				}
				if(this.direction == "jump" && this.cnt >= 10) {
					this.direction = "fall";
					this.cnt = 0;
				}
				if(this.direction == "fall") {
					var dec = true;
					for(var ii = 0; ii < floorObjects.length; ii++) {
						if(floorObjects[ii].y - floorHeight == this.y) { // same y-axis
							if(floorObjects[ii].x <= (this.x + this.w / 2) && (floorObjects[ii].x + floorObjects[ii].w) >= this.x + 0.5 * this.w) { // in the x-axis floor
								dec = false;
							} else {

								if(floorObjects[ii].x <= (this.x + this.w / 2)) {
									console.log("Falling because " + this.name + " is too in the left." );
								}
								if(floorObjects[ii].x + floorObjects[ii].w >= this.x + 1.3 * this.w) {
									console.log("Falling because " + this.name + " is too in the right." );
								}
							}
						}
					}
					if(dec) {
						this.y += this.strenght;
					}
				}
			}

			hasHat() {
				this.hat=true;
			}
		}

		class RCorner {
			constructor(x, y, name="rcorner", color="#FFA500") {
				this.x = x; this.y = y; this.h = 8; this.w = 4;
				this.name = name; this.color = color;
				console.log(this.name + ' at (x:' + this.x + ', y:' + this.y + ').');
			}

			draw() {
				var y = this.y - this.h;
				ctx.beginPath();
				ctx.moveTo(this.x, y);
				ctx.lineTo(this.x, y + this.h);
				ctx.lineTo(this.x + this.w, y + (this.h / 2));
				ctx.lineTo(this.x, y);
				ctx.fillStyle = this.color;
				ctx.fill();
				ctx.closePath();
			}

			collide(sm) {
				if(sm.y == this.y) { // y-axis
					// console.log(sm.name + " is in the same h level than " + this.name + ".")
					if(sm.x <= this.x + this.w) { // x-axis
						console.log(this.name + " ping at (x:" + (this.x - this.w) + ", y:" + (this.y / 2) + ").");
						sm.toggleMovement("right");
					}
				}
			}
		}

		class LCorner {
			constructor(x, y, name="lcorner", color="#FFA500") {
				this.x = x; this.y = y; this.h = 10; this.w = 4;
				this.name = name; this.color = color;
				console.log(this.name + ' at (x:' + this.x + ', y:' + this.y + ').');
			}

			draw() {
				var y = this.y - this.h;
				ctx.beginPath();
				ctx.moveTo(this.x, y);
				ctx.lineTo(this.x, y + this.h);
				ctx.lineTo(this.x - this.w, y + (this.h / 2));
				ctx.lineTo(this.x, y);
				ctx.fillStyle = this.color;
				ctx.fill();
				ctx.closePath();
			}

			collide(sm) {
				if(sm.y == this.y) { // y-axis
					// console.log(sm.name + " is in the same h level than " + this.name + ".")
					if(sm.x + sm.w >= this.x) { // x-axis
						console.log(this.name + " ping at (x:" + (this.x - this.w) + ", y:" + (this.y / 2) + ").");
						sm.toggleMovement("left");
					}
				}
			}
		}

		class Text {
			constructor(x, y, size, text) {
				this.x = x; this.y = y; this.size = size; this.text = text;
				console.log('text at (x:' + this.x + ', y:' + this.y + ').');
			}

			draw() {
				if(this.size == "small") {
					ctx.font = "11px sans-serif";
				}
				if(this.size == "normal") {
					ctx.font = "16px sans-serif";
				}
				if(this.size == "large") {
					ctx.font = "48px sans-serif";
				}
				ctx.fillText(this.text, this.x, this.y);
			}

			collide(sm) { }
		}

		class GameSet {
			constructor() {
				this.snowman = null;
				this.exit = null;
				this.hat = null;
				this.floors = [];
				this.corners = [];
				this.texts = [];
				this.win = false;
			}

			hasWin() {
				return this.win;
			}

			draw() {
				var gameElements = this.floors.concat(this.corners).concat(this.texts);
				gameElements.push(this.hat); gameElements.push(this.exit);
				gameElements.forEach(function(item, idx) {
					item.draw(); 
				});
				for(var ii=0; ii < gameElements.length; ii++) {
					gameElements[ii].collide(this.snowman, this.exit);
				}
				this.snowman.draw();
				this.snowman.move();
				this.snowman.fall(this.floors);
			}

		}

		/* -------------------------------------------------------------- */
		function Level1() {
			var map = new GameSet();
			map.snowman = new Snowman(200, 310);
			map.exit = new Exit(75, 310, visible=false);
			map.hat = new Hat(325, 310, visible=true);
			map.floors.push(new Floor(10, 320, width - 20));
			map.corners.push(new RCorner(10, 310));
			map.corners.push(new LCorner(470, 310));
			map.texts.push(new Text(10, 15, "normal", "Mr. Snowman has lost his orange hat."));
			map.texts.push(new Text(10, 30, "normal", "Can you help him to find it? Use the "));
			map.texts.push(new Text(10, 45, "normal", "arrow keys to indicate to Mr. Snowman"));
			map.texts.push(new Text(10, 60, "normal", "where to find the hat."));
			return map;
		}
		function Level2() {
			var map = new GameSet();
			map.snowman = new Snowman(280, 310);
			map.floors.push(new Floor(10, 320, width - 20, name="floor-1"));
			map.floors.push(new Floor(100, 310, 175, name="floor-2"));
			map.floors.push(new Floor(150, 300, 75, anme="floor-3"));
			map.corners.push(new LCorner(width - 10, 310, name="lcorner-1"));
			map.corners.push(new LCorner(225, 290, name="lcorner-3"));
			map.corners.push(new RCorner(10, 310, name="rcorner-1"));
			map.corners.push(new RCorner(100, 300, name="rcorner-2"));
			map.exit = new Exit(375, 310, visible=false);
			map.hat = new Hat(160, 290, visible=true);
			map.texts.push(new Text(10, 30, "normal", "By pressing the key 'space' you can"));
			map.texts.push(new Text(10, 45, "normal", "make Mr. Snowman to jump!"));
			return map;
		}

		function Level3() {
			var map = new GameSet();
			map.floors.push(new Floor(10, 320, width - 20));
			map.floors.push(new Floor(100, 280, 100));
			map.floors.push(new Floor(150, 300, 100));
			
			map.snowman = new Snowman(300, 315);
			map.exit = new Exit(375, 315, visible=true);
			map.hat = new Hat(160, 300, visible=true);
			
			map.corners.push(new RCorner(10, 315));
			map.corners.push(new LCorner(470, 315));
			return map;
		}
		/* -------------------------------------------------------------- */

		/* -------------------------------------------------------------- */
		map = Level3();

		function draw() {
			ctx.clearRect(0, 0, width, height);
			if(rightPressed) {
				map.snowman.start("right");
			}
			if(leftPressed) {
				map.snowman.start("left");
			}
			if(upPressed) {
				map.snowman.jump();
				upPressed = false;
			}

			map.draw();

			if(map.hasWin()) {

			}
		}

		/* -------------------------------------------------------------- */
		function keyDownHandler(e) {
			if(e.keyCode == 39) {
				console.log("right arrow key was pressed.");
				rightPressed = true;
			} else if(e.keyCode == 37) {
				console.log("left arrow key was pressed.");
				leftPressed = true;
			} else if(e.keyCode == 32) {
				console.log("space key was pressed.");
				upPressed = true;
			}
		}

		function keyUpHandler(e) {
			if(e.keyCode == 39) {
				rightPressed = false;
			} else if(e.keyCode == 37) {
				leftPressed = false;
			} else if(e.keyCode == 32) {
				upPressed = false;
			}
		}

		setInterval(draw, 15);
	</script>
</body>
</html>

